name: Calculator App Validiations and tests

run-name: 'Calculator App Validiations and tests | Branch = ${{github.ref_name}}'

on:
  push:
  workflow_dispatch:

permissions: 
  id-token: write
  contents: read

jobs:
  frontend-validations:
    runs-on: ubuntu-latest 
    steps:
      - name: code-checkout
        uses: actions/checkout@v4 
      - name: node-setup
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
      - name: code-validations
        run: |
          cd frontend
          npm ci
          npx htmlhint "**/*.html"
          npm run lint 
          npm run test:ci
  backend_valdiations:
    runs-on: ubuntu-latest
    defaults:
      run: 
        working-directory: backend/
    steps:
      - name: code-checkout
        uses: actions/checkout@v4 
      - name: pyhton-setup
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"
      - name: install-dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install -r requirements-dev.txt
      - name: backend-validations
        run: |
          source venv/bin/activate
          make lint
          make test
  e2e_testing:
    runs-on: ubuntu-latest
    environment: e2e_testing
    env:
      MYSQL_HOST: ${{vars.MYSQL_HOST}}
      MYSQL_DB: ${{vars.MYSQL_DB}}
      MYSQL_USER: ${{vars.MYSQL_USER}}
      MYSQL_PASSWORD: ${{secrets.MYSQL_PASSWORD}}
      SERVER_NAME: ${{vars.SERVER_NAME}}
      FRONTEND_HOST: ${{vars.FRONTEND_HOST}}
      FRONTEND_PORT: ${{vars.FRONTEND_PORT}}
      BACKEND_HOST: ${{vars.BACKEND_HOST}}
      BACKEND_PORT: ${{vars.BACKEND_PORT}}

    steps:
      - name: code-checkout
        uses: actions/checkout@v4 
      - name: pyhton-setup
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"
      - name: node-setup
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
      - name: init-mysql-db
        run: |
          sudo systemctl start mysql.service
          cd database
          envsubst < init.sql.template \
                > init.sql

          envsubst < seed.sql.template \
                          > seed.sql
          
          cat init.sql 

          sudo mysql -h localhost -u root -proot < init.sql
          sudo mysql -h localhost -u root -proot < seed.sql
      - name: start-backend
        run: |
          cd backend
          python -m venv venv
          source venv/bin/activate
          pip install -r requirements-dev.txt
          python app.py &
      - name: start-frontend
        run: |
          cd frontend
          npm install
          npm run start &
          until curl -s http://localhost:3000; do
            echo "Waiting for frontend..."
            sleep 2
          done
      - name: setup-proxy
        run: |
          sudo apt-get install -y nginx
          
          envsubst  < nginx/nginx.conf.template \
          > /etc/nginx/conf.d/nginx.conf
          echo '--------------------------------------------'
          cat /etc/nginx/conf.d/nginx.conf

          sudo systemctl start nginx

      - name: run e2e tests
        run: |
          curl http://localhost:8080/
          echo '--------------------------------------------'
          curl http://localhost:5000/history
          echo '--------------------------------------------'
          curl http://localhost:8080/api/history